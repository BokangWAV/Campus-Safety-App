<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report an Incident - Campus Safety App</title>

  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>

  <link href="styles/dashboard.css" rel="stylesheet">

  <style>
    form div {
      margin-bottom: 1.5rem;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    label {
      font-weight: bold;
      display: block;
      margin-bottom: 0.5rem;
    }

    textarea {
      resize: vertical;
    }

    button[type="submit"] {
      background-color: #1a3e57;
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }

    button[type="submit"]:hover {
      background-color: #214a61;
    }

    .dashboard-card {
      max-width: 600px;
      margin: 0 auto;
      padding: 2rem;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 800px) {
      .dashboard-card {
        padding: 1rem;
      }
    }

    .dashboard-card,
    .dashboard-card:hover {
      transform: none !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
    }
  </style>
</head>

<body>
  <div class="header">
    <h2>Campus Safety</h2>
    <div class="mobile-nav-toggle" onclick="toggleMobileMenu()">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <ul id="headerMenu">
      <li><a href="dashboardtest.html">Dashboard</a></li>
      <li><a href="profile.html">Profile Page</a></li>
      <li><a href="alerts.html">Emergency Alerts</a></li>
      <li><a href="reports.html">Report an Incident</a></li>
      <li><a href="summary.html">Reports Summary</a></li>
      <li><a href="article.html">Articles</a></li>
      <li><a href="request.html">Requests</a></li>
      <li><a href="ai-page.html">ChatBot</a></li>
      <li><a href="unavailable.html">Contact Security</a></li>
    </ul>
  </div>

  <div class="header">
    <h2>Campus Safety</h2>
    <div class="mobile-nav-toggle" onclick="toggleMobileMenu()">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <ul id="headerMenu">
      <li><a href="dashboardtest.html">Dashboard</a></li>
      <li><a href="profile.html">Profile Page</a></li>
      <li><a href="alerts.html">Emergency Alerts</a></li>
      <li><a href="reports.html">Report an Incident</a></li>
      <li><a href="article.html">Articles</a></li>
      <li><a href="request.html">Requests</a></li>
      <li><a href="ai-page.html">ChatBot</a></li>
      <li><a href="unavailable.html">Contact Security</a></li>
    </ul>
  </div>

  <div class="dashboard-container">
    <div class="dashboard-header">
      <h1>Report an Incident</h1>
      <p>Use the form below to submit a new incident report.</p>
    </div>

    <div class="dashboard-content">
      <div class="dashboard-card">
        <form id="reportForm" onsubmit="event.preventDefault(); submitReport();">
          <div>
            <label for="geoLocation">Your Current Location (Latitude, Longitude):</label>
            <input type="text" id="geoLocation" readonly>
          </div>

          <div>
            <label for="description">Incident Description:</label>
            <textarea id="description" rows="4" required></textarea>
          </div>

          <div>
            <label for="location">Incident Location:</label>
            <select id="buildings" required>

            </select>
          </div>

          <div>
            <label for="urgencyLevel">Urgency Level:</label>
            <select id="urgencyLevel" required>
              <option value="Low">Low</option>
              <option value="Medium">Medium</option>
              <option value="High">High</option>
            </select>
          </div>

          <div>
            <label for="imageUpload">Upload Images (optional):</label>
            <input type="file" id="imageUpload" accept="image/*" multiple>
          </div>

          <div>
            <label for="videoUpload">Upload Videos (optional):</label>
            <input type="file" id="videoUpload" accept="video/*" multiple>
          </div>

          <button type="submit">Submit Report</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    var APIBuildings;
    const firebaseConfig = {
      apiKey: "AIzaSyCLDopG2959mh9Wtl3nDM0FAWZBNc3GGLo",
      authDomain: "tdkus-fcf53.firebaseapp.com",
      projectId: "tdkus-fcf53",
      storageBucket: "tdkus-fcf53.appspot.com",
      messagingSenderId: "144411393779",
      appId: "1:144411393779:web:54a4013e6da2a974b4c186",
      measurementId: "G-5BPYZE953B"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    async function uploadFiles(files, folderName) {
      const uploadPromises = Array.from(files).map(file => {
        const storageRef = storage.ref(`${folderName}/${file.name}`);
        return storageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL());
      });
      return Promise.all(uploadPromises);
    }

    async function submitReport() {
      const geoLocation = document.getElementById("geoLocation").value;
      const description = document.getElementById("description").value;
      const location = document.getElementById("buildings").value;
      const urgencyLevel = document.getElementById("urgencyLevel").value;
      const imageFiles = document.getElementById("imageUpload").files;
      const videoFiles = document.getElementById("videoUpload").files;

      let imageUrls = [];
      let videoUrls = [];

      if (imageFiles.length > 0) {
        imageUrls = await uploadFiles(imageFiles, 'incident_images');
      }

      if (videoFiles.length > 0) {
        videoUrls = await uploadFiles(videoFiles, 'incident_videos');
      }

        const reportData = {
          geoLocation: geoLocation,
          description: description,
          location: location,
          urgencyLevel: urgencyLevel,
          status: "Open",
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          imageUrls: imageUrls,
          videoUrls: videoUrls
        };

        try {
            const uid = window.localStorage.getItem('uid');
            const response = await fetch(`https://sdp-campus-safety.azurewebsites.net/reports/${uid}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(reportData)
            });
    
            if (response.ok) {
                //console.log('Updated user data:', updatedUser);
                //window.location.href = "./profile.html";
                //window.location.href = '/profile.html'; // Redirect after successful submission
                document.getElementById("reportForm").reset();
            } else {
                console.error("Error submitting report:", error);
                alert("Error submitting report. Please try again.");
            }
        } catch (error) {
            console.error(error);
        }

        //await db.collection('reports').add(reportData);
        //alert("Report submitted successfully!");
        
    }

    async function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          document.getElementById('geoLocation').value = position.coords.latitude + ", " + position.coords.longitude;
        }, function (error) {
          console.error("Error getting location: ", error);
          document.getElementById('geoLocation').value = "Unable to retrieve location.";
        });
      } else {
        document.getElementById('geoLocation').value = "Geolocation is not supported by this browser.";
      }
      setTempBuildings()
      /*
          const response = await fetch(`https://witsgobackend.azurewebsites.net/v1/map/getBuildings`, {
              method: 'GET',
              headers: {
                  'Content-Type': 'application/json'
              },
          });
  
          if (!response.ok) {
              setTempBuildings()
          }else{
            data = await response.json()
            console.log(data);
          }

          APIBuildings.forEach((data)=>{
            const option = document.createElement('option');

            option.value = data.building_name;
            option.innerText = building_name;
            document.getElementById('buildings').appendChild(option)
          });
      */
      APIBuildings.sort((a, b) => a.building_name.localeCompare(b.building_name));
      APIBuildings.forEach((data)=>{
        console.log(data)
        const option = document.createElement('option');

        option.value = data.building_name;
        option.innerText = data.building_name;
        document.getElementById('buildings').appendChild(option)
      });
    }

    function setTempBuildings(){
      APIBuildings = [
        {
          "building_name": "OLS",
        },
        {
          "building_name": "Wits Science Stadium",
        },
        {
          "building_name": "Faculty of Commerce, Law and Management",
        },
        {
          "building_name": "WITS Entrance 9",
        },
        {
          "building_name": "Commerce library",
        },
        {
          "building_name": "MSL",
        },
        {
          "building_name": "NCB",
        },
        {
          "building_name": "MSB",
        },
        {
          "building_name": "CCDU",
        },
        {
          "building_name": "FNB Building",
        },
        {
          "building_name": "Wits Law School",
        },
        {
          "building_name": "DJ Du Plessis",
        },
        {
          "building_name": "Wits Law Clinic",
        },
        {
          "building_name": "Chemistry Labs",
        },
        {
          "building_name": "Flower Hall",
        },
        {
          "building_name": "Chamber of Mines",
        },
        {
          "building_name": "ARM Building",
        },
        {
          "building_name": "WITS 3rd+ Year Parking",
        },
        {
          "building_name": "Vida Amic Deck",
        },
        {
          "building_name": "Amic Deck",
        },
        {
          "building_name": "2nd+ Year Parking",
        },
        {
          "building_name": "Law Lawns",
        },
        {
          "building_name": "Hall 29",
        },
        {
          "building_name": "Olives and Plates Wits",
        },
        {
          "building_name": "Barnato Hall",
        },
        {
          "building_name": "David Webster",
        },
        {
          "building_name": "Wits Anglo American Digital Dome",
        },
        {
          "building_name": "Bozzoli",
        },
        {
          "building_name": "Wits Musalla",
        },
        {
          "building_name": "Mens Halls Of Residence",
        },
        {
          "building_name": "College House",
        },
        {
          "building_name": "Wits University Jubilee Hall",
        },
        {
          "building_name": "Wits Rugby Stadium",
        },
        {
          "building_name": "Old Mutual Sports Hall",
        },
        {
          "building_name": "The Matrix",
        },
        {
          "building_name": "William Cullen Library",
        },
        {
          "building_name": "Wits Inter Campus Bus Service",
        },
        {
          "building_name": "North West Engineering Building",
        },
        {
          "building_name": "chool of Mechanical, Industrial and Aeronautical Engineering"
        },
        {
          "building_name": "Solomon Mahlangu House"
        },
        {
          "building_name": "Main Hall"
        },
        {
          "building_name": "RS Exam Hall"
        },
        {
          "building_name": "Wartenweiler Library"
        },
        {
          "building_name": "Physics Building"
        },
        {
          "code": null,
          "_id": "66e8a6288515e58447d791d3",
          "building_name": "Biology Building",
          "campus": [
            "east_campus"
          ],
          "type": [
            "building"
          ],
          "latitude": -26.1911103,
          "longitude": 28.0312252,
          "building_id": "fa145529",
          "created_at": "2024-09-16T21:42:00.103Z",
          "__v": 0
        },
        {
          "code": null,
          "_id": "66e8a65a8515e58447d791d5",
          "building_name": "Wits School of Arts",
          "campus": [
            "east_campus"
          ],
          "type": [
            "building"
          ],
          "latitude": -26.1921308,
          "longitude": 28.0324523,
          "building_id": "0de6d1b8",
          "created_at": "2024-09-16T21:42:50.215Z",
          "__v": 0
        },
        {
          "code": null,
          "_id": "66e8a6838515e58447d791d7",
          "building_name": "Wits Theatre Complex",
          "campus": [
            "east_campus"
          ],
          "type": [
            "building"
          ],
          "latitude": -26.1925313,
          "longitude": 28.0307648,
          "building_id": "0bdb22ab",
          "created_at": "2024-09-16T21:43:31.943Z",
          "__v": 0
        },
        {
          "code": null,
          "_id": "66e8a6ad8515e58447d791d9",
          "building_name": "Wits Journalism Department",
          "campus": [
            "east_campus"
          ],
          "type": [
            "building"
          ],
          "latitude": -26.1925313,
          "longitude": 28.0307648,
          "building_id": "8669ecbc",
          "created_at": "2024-09-16T21:44:13.783Z",
          "__v": 0
        }
      ]
    }

    window.onload = function () {
      getLocation();
    };
  </script>

</body>

</html>
